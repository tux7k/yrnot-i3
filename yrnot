#!/bin/sh

# yrnot (yr.no terminal forecast grabber) v1
# A scripts that grabs yr.no forecasts through the api, parses it using json, and displays it beautifully with formatting
#
# dependencies:
# curl
# jq
#
# Licensed under GPL 3.0
# by tuck

# --- FILTERS
# Current Obs - instant - next hour
export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/usr/1000/bus
export DISPLAY=:0.0
export XAUTHORITY=/home/tux/.Xauthority

if [ -r "$HOME/.dbus/Xdbus" ]; then
    source "$HOME/.dbus/Xdbus"
fi


nextOneHour=".properties.timeseries[0].data.next_1_hours" # data in the next one hour
currentObs=".properties.timeseries[0].data.instant.details" # instant data
currentTempCel="${currentObs}.air_temperature" # Air Temperature
currentPASLhPa="${currentObs}.air_pressure_at_sea_level" # Air Pressure @ Sea Level (hPa)
currentCAF="${currentObs}.cloud_area_fraction" # Cloud Area Fraction (%)
currentHumidity="${currentObs}.relative_humidity" # Relative Humidity (%)
currentWindDirection="${currentObs}.wind_from_direction" # Wind Direction (deg)
currentWindSpeed="${currentObs}.wind_speed" # Wind Speed (m/s)
precipOneHour="${nextOneHour}.details.precipitation_amount"
conditionsOneHour="${nextOneHour}.summary.symbol_code"

# --- MAIN
cachesource="/home/$(whoami)/.cache/yrnot.cache"
cfgsource="/home/$(whoami)/.config/yrnot/cfg"
if [ -f $cfgsource ]; then
    source $cfgsource
    
    # --- GET THE DATA
    if [ -f $cachesource ] && [[ $1 != "-f" ]]; then
        yrnodata=$(cat $cachesource)
    else
        yrnodata=$(curl -A 'tux/0.1' -s "https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}")
    fi
    # --- RUN FILTERS - for more info read the filters area
    cTempC=$(echo ${yrnodata} | jq ${currentTempCel})
    cPressurehPa=$(echo ${yrnodata} | jq ${currentPASLhPa})
    cCAFp=$(echo ${yrnodata} | jq ${currentCAF})
    cRHumidP=$(echo ${yrnodata} | jq ${currentHumidity})
    cWindDirectionD=$(echo ${yrnodata} | jq ${currentWindDirection})
    cWindSpeedMS=$(echo ${yrnodata} | jq ${currentWindSpeed})
    cPrecipOneHour=$(echo ${yrnodata} | jq ${precipOneHour})
    cCondOneHour=$(echo ${yrnodata} | jq ${conditionsOneHour})
    cCondOneHour=$(echo "${cCondOneHour}" | sed "s/\"//g" )

    case "$cCondOneHour" in 
        clearsky_day) cCondOneHour="ï¸ï¸â˜€ï¸ Sunny"; cCondOneHourEmoji="â˜€ï¸" ;;
        clearsky_night) cCondOneHour="ğŸŒ™ Night"; cCondOneHourEmoji="ğŸŒ™" ;;
        partlycloudy_day) cCondOneHour="ğŸŒ¤ï¸ Partly Cloudy"; cCondOneHourEmoji="ï¸ğŸŒ¤ï¸" ;;
        partlycloudy_night) cCondOneHour="ğŸŒ¤ï¸ Partly Cloudy"; cCondOneHourEmoji="ï¸ğŸŒ¤ï¸" ;;
        fair_day) cCondOneHour="â›… Fair Day"; cCondOneHourEmoji="â›…" ;;        
        fair_night) cCondOneHour="â›… Fair Night"; cCondOneHourEmoji="â›…" ;;
        cloudy) cCondOneHour="â˜ï¸  Cloudy"; cCondOneHourEmoji="â˜ï¸" ;;
        rainshowers_day) cCondOneHour="ğŸŒ¦ï¸ Rain Showers"; cCondOneHourEmoji="ğŸŒ¦ï¸";;
        lightrainshowers_day) cCondOneHour="ğŸŒ¦ï¸ Light Rain Showers"; cCondOneHourEmoji="ğŸŒ¦ï¸";;
        lightrainshowers_night) cCondOneHour="ğŸŒ¦ï¸ Light Rain Showers"; cCondOneHourEmoji="ğŸŒ¦ï¸";;
        heavyrainshowers_day) cCondOneHour="ğŸŒ¦ï¸ Heavy Rain Showers"; cCondOneHourEmoji="ğŸŒ¦ï¸";;
        heavyrainshowers_night) cCondOneHour="ğŸŒ¦ï¸ Heavy Rain Showers"; cCondOneHourEmoji="ğŸŒ¦ï¸";;
        rainshowers_night) cCondOneHour="ğŸŒ¦ï¸ Rain Showers"; cCondOneHourEmoji="ğŸŒ¦ï¸";;
        rainshowersandthunder_day) cCondOneHour="â›ˆï¸  Rain Showers and Thunder"; cCondOneHourEmoji="â›ˆï¸";;
        rainshowersandthunder_night) cCondOneHour="â›ˆï¸  Rain Showers and Thunder"; cCondOneHourEmoji="â›ˆï¸";;
        sleetshowers_day) cCondOneHour="ğŸŒ¨ï¸ Sleet Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        sleetshowers_night) cCondOneHour="ğŸŒ¨ï¸ Sleet Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        lightsleetshowers_day) cCondOneHour="ğŸŒ¨ï¸ Light Sleet Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        lightsleetshowers_night) cCondOneHour="ğŸŒ¨ï¸ Light Sleet Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        heavysleetshowers_day) cCondOneHour="ğŸŒ¨ï¸ Heavy Sleet Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        heavysleetshowers_night) cCondOneHour="ğŸŒ¨ï¸ Heavy Sleet Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        snowshowers_day) cCondOneHour="ğŸŒ¨ï¸ Snow Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        snowshowers_night) cCondOneHour="ğŸŒ¨ï¸ Snow Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        lightsnowshowers_day) cCondOneHour="ğŸŒ¨ï¸ Light Snow Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        lightsnowshowers_night) cCondOneHour="ğŸŒ¨ï¸ Light Snow Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        heavysnowshowers_day) cCondOneHour="ğŸŒ¨ï¸ Heavy Snow Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        heavysnowshowers_night) cCondOneHour="ğŸŒ¨ï¸ Heavy Snow Showers"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        rain) cCondOneHour="ğŸŒ§ï¸ Rain"; cCondOneHourEmoji="ğŸŒ§ï¸";;
        lightrain) cCondOneHour="ğŸŒ§ï¸ Light Rain"; cCondOneHourEmoji="ğŸŒ§ï¸";;
        heavyrain) cCondOneHour="ğŸŒ§ï¸ Heavy Rain"; cCondOneHourEmoji="ğŸŒ§ï¸";;
        heavyrainandthunder) cCondOneHour="â›ˆï¸  Heavy Rain and Thunder"; cCondOneHourEmoji="â›ˆï¸";;
        sleet) cCondOneHour="ğŸŒ¨ï¸ Sleet"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        lightsleet) cCondOneHour="ğŸŒ¨ï¸ Light Sleet"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        heavysleet) cCondOneHour="ğŸŒ¨ï¸ Heavy Sleet"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        lightsnow) cCondOneHour="ğŸŒ¨ï¸ Light Snow"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        heavysnow) cCondOneHour="ğŸŒ¨ï¸ Heavy Snow"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        snow) cCondOneHour="ğŸŒ¨ï¸ Snow"; cCondOneHourEmoji="ğŸŒ¨ï¸";;
        fog) cCondOneHour="ğŸŒ«ï¸ Fog"; cCondOneHourEmoji="ğŸŒ«ï¸";;
        snowandthunder) cCondOneHour="ğŸŒ¨ï¸âš¡ Snow and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        sleetshowersandthunder_day) cCondOneHour="ğŸŒ¨ï¸âš¡ Sleet Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        sleetshowersandthunder_night) cCondOneHour="ğŸŒ¨ï¸âš¡ Sleet Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        snowshowersandthunder_day) cCondOneHour="ğŸŒ¨ï¸âš¡ Snow Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        snowshowersandthunder_night) cCondOneHour="ğŸŒ¨ï¸âš¡ Snow Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        rainandthunder) cCondOneHour="â›ˆï¸  Rain and Thunder"; cCondOneHourEmoji="â›ˆï¸";;
        lightrainandthunder) cCondOneHour="â›ˆï¸  Light Rain and Thunder"; cCondOneHourEmoji="â›ˆï¸";;
        sleetandthunder) cCondOneHour="ğŸŒ¨ï¸âš¡ Sleet and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        lightsleetandthunder) cCondOneHour="ğŸŒ¨ï¸âš¡ Light Sleet and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        heavysleetandthunder) cCondOneHour="ğŸŒ¨ï¸âš¡ Heavy Sleet and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        lightsnowandthunder) cCondOneHour="ğŸŒ¨ï¸âš¡ Light Snow and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        heavysnowandthunder) cCondOneHour="ğŸŒ¨ï¸âš¡ Light Snow and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        lightrainshowersandthunder_day) cCondOneHour="ğŸŒ¦ï¸âš¡ Light Rain Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¦ï¸âš¡";;
        lightrainshowersandthunder_night) cCondOneHour="ğŸŒ¦ï¸âš¡ Light Rain Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¦ï¸âš¡";;
        heavyrainshowersandthunder_day) cCondOneHour="ğŸŒ¦ï¸âš¡ Heavy Rain Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¦ï¸âš¡";;
        heavyrainshowersandthunder_night) cCondOneHour="ğŸŒ¦ï¸âš¡ Heavy Rain Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¦ï¸âš¡";;
        lightsleetshowersandthunder_day) cCondOneHour="ğŸŒ¨ï¸âš¡ Light Sleet Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        lightsleetshowersandthunder_night) cCondOneHour="ğŸŒ¨ï¸âš¡ Light Sleet Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        heavysleetshowersandthunder_day) cCondOneHour="ğŸŒ¨ï¸âš¡ Heavy Sleet Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        heavysleetshowersandthunder_night) cCondOneHour="ğŸŒ¨ï¸âš¡ Heavy Sleet Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        lightsnowshowersandthunder_day) cCondOneHour="ğŸŒ¨ï¸âš¡ Light Snow Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        lightsnowshowersandthunder_night) cCondOneHour="ğŸŒ¨ï¸âš¡ Light Snow Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        heavysnowshowersandthunder_day) cCondOneHour="ğŸŒ¨ï¸âš¡ Heavy Snow Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        heavysnowshowersandthunder_night) cCondOneHour="ğŸŒ¨ï¸âš¡ Heavy Snow Showers and Thunder"; cCondOneHourEmoji="ğŸŒ¨ï¸âš¡";;
        
    esac
    if [[ $1 == "-n" ]] || [[ $2 == "-n" ]]; then
        if [[ $cCondOneHour == *"Snow"* ]] || [[ $cCondOneHour == *"Sleet"* ]] || [[ $cCondOneHour == *"Rain"* ]]; then
           notify-send "${cPrecipOneHour} mm of ${cCondOneHour}" "coming in the next hour."
        else
            notify-send "${cCondOneHour}" "in the next hour."
        fi
        exit
    fi
    if [[ $1 == "-s" ]] || [[ $2 == "-s" ]]; then
        echo "${cCondOneHourEmoji} - ğŸŒ¡ï¸ ${cTempC} C - â˜‚ï¸  ${cPrecipOneHour} mm"
    else
        echo "${cCondOneHour}"
        echo "------------------------"
        echo "ğŸŒ¡ï¸  Temperature: ${cTempC} C"
        echo "âš—ï¸  Humidity: ${cRHumidP}%"
        echo "â˜ï¸  Cloud Cover: ${cCAFp}%"
        echo "ğŸ’¨  Wind: ${cWindSpeedMS} m/s - ${cWindDirectionD} deg"
        echo "â˜‚ï¸  Precipitation (next hour): ${cPrecipOneHour} mm"
    fi
fi


# jq '.properties.timeseries[0].data' yrexample.json
